<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Staffing Whiteboard</title>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      :root {
        --bg: #0b1020;
        --card: #121a33;
        --muted: rgba(255,255,255,.65);
        --text: rgba(255,255,255,.92);
        --border: rgba(255,255,255,.12);
        --shadow: 0 10px 25px rgba(0,0,0,.35);
        --pill: rgba(255,255,255,.12);
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        background: radial-gradient(1200px 700px at 20% 0%, #15204a 0%, var(--bg) 55%);
        color: var(--text);
      }
      .wrap { max-width: 1200px; margin: 0 auto; padding: 20px; }
      .topbar {
        display: flex; gap: 12px; align-items: center; justify-content: space-between;
        padding: 14px 16px; border: 1px solid var(--border); border-radius: 16px;
        background: rgba(18,26,51,.78); box-shadow: var(--shadow);
        backdrop-filter: blur(8px);
      }
      .title { display:flex; flex-direction: column; gap: 2px; }
      .title h1 { font-size: 18px; margin: 0; }
      .meta { font-size: 12px; color: var(--muted); display:flex; gap: 14px; flex-wrap: wrap; }
      .controls { display:flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
      input, select, button {
        border: 1px solid var(--border);
        background: rgba(255,255,255,.06);
        color: var(--text);
        border-radius: 12px;
        padding: 10px 12px;
        font-size: 14px;
        outline: none;
      }
      input::placeholder { color: rgba(255,255,255,.45); }
      button { cursor: pointer; }
      button.primary {
        background: rgba(29,185,84,.15);
        border-color: rgba(29,185,84,.35);
      }
      button.danger {
        background: rgba(255,77,77,.12);
        border-color: rgba(255,77,77,.35);
      }
      .tabs { margin-top: 14px; display: flex; gap: 10px; flex-wrap: wrap; }
      .tab {
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,.06);
        cursor: pointer;
      }
      .tab.active {
        background: rgba(255,255,255,.12);
        border-color: rgba(255,255,255,.20);
      }

      .board {
        margin-top: 14px;
        display: grid;
        grid-template-columns: 1.05fr repeat(4, 1fr);
        gap: 12px;
      }
      @media (max-width: 980px) {
        .board { grid-template-columns: 1fr 1fr; }
      }
      @media (max-width: 560px) {
        .board { grid-template-columns: 1fr; }
      }

      .col {
        border: 1px solid var(--border);
        border-radius: 16px;
        background: rgba(18,26,51,.65);
        box-shadow: var(--shadow);
        min-height: 420px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .colHeader {
        padding: 12px 12px 10px 12px;
        border-bottom: 1px solid var(--border);
        display:flex; align-items:center; justify-content: space-between;
      }
      .colHeader h2 { margin: 0; font-size: 14px; letter-spacing: .2px; }
      .colHeader span { font-size: 12px; color: var(--muted); }
      .dropZone {
        padding: 12px;
        display:flex;
        flex-direction: column;
        gap: 10px;
        flex: 1;
      }
      .hint {
        font-size: 12px; color: rgba(255,255,255,.55);
        border: 1px dashed rgba(255,255,255,.18);
        border-radius: 14px;
        padding: 10px 12px;
      }
      .card {
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 12px;
        background: rgba(255,255,255,.06);
        box-shadow: 0 8px 18px rgba(0,0,0,.25);
      }
      .row { display:flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      .cardTop { display:flex; align-items:flex-start; justify-content: space-between; gap: 10px; }
      .name { font-weight: 700; font-size: 14px; margin: 0; }
      .small { font-size: 12px; color: var(--muted); }
      .pill {
        display:inline-flex; align-items:center; gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        background: var(--pill);
        border: 1px solid rgba(255,255,255,.14);
        font-size: 12px;
        white-space: nowrap;
      }
      .badge {
        display:inline-flex;
        align-items:center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,.18);
        font-size: 12px;
      }
      .badge.bhd {
        background: rgba(29,185,84,.15);
        border-color: rgba(29,185,84,.35);
      }
      .badge.notbhd { background: rgba(255,255,255,.08); }
      .actions { display:flex; gap: 8px; align-items: center; }
      .iconBtn { padding: 8px 10px; border-radius: 12px; font-size: 12px; }
      .formRow { display:flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; }
      .panel {
        margin-top: 14px;
        padding: 14px;
        border: 1px solid var(--border);
        border-radius: 16px;
        background: rgba(18,26,51,.55);
        box-shadow: var(--shadow);
      }
      .panel h3 { margin: 0 0 10px 0; font-size: 14px; }
      .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      @media (max-width: 800px) { .grid2 { grid-template-columns: 1fr; } }
      .mutedLine { font-size: 12px; color: var(--muted); margin-top: 8px; }
      .dragOver {
        outline: 2px solid rgba(255,255,255,.22);
        outline-offset: -2px;
        background: rgba(255,255,255,.04);
      }
      .protectedTag {
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,.18);
        background: rgba(255,255,255,.08);
        color: rgba(255,255,255,.8);
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useState } = React;

      const ROLES = [
        "Problem Solver",
        "Picker",
        "Stower",
        "Process Guide - Pick",
        "Process Guide - Stow",
        "Decanter",
        "Pick Transporter",
        "Stow Transporter",
        "WaterSpider",
        "ICQA",
      ];

      // Special protected badge pool column key:
      const BADGE_POOL_KEY = "badgePool";

      const STAFFING_COLS = [
        { key: BADGE_POOL_KEY, title: "Badge Pool", protected: true },
        { key: "planned", title: "Planned" },
        { key: "onFloor", title: "On Floor" },
        { key: "break", title: "Break / Support" },
        { key: "off", title: "Off / Not Assigned" },
      ];

      const UNI_COLS = [
        { key: "todo", title: "To Do" },
        { key: "doing", title: "In Progress" },
        { key: "done", title: "Done" },
        { key: "blocked", title: "Blocked" },
      ];

      const todayStr = () => {
        const d = new Date();
        return d.toLocaleDateString(undefined, { weekday: "long", year: "numeric", month: "long", day: "numeric" });
      };

      const nowStamp = () => new Date().toLocaleString();
      const uid = () => Math.random().toString(16).slice(2) + "-" + Math.random().toString(16).slice(2);

      function safeParse(json, fallback) {
        try { return JSON.parse(json); } catch { return fallback; }
      }

      function App() {
        const [loginName, setLoginName] = useState(() => localStorage.getItem("swb_login") || "");
        const [activeTab, setActiveTab] = useState("staffing");
        const [lastUpdated, setLastUpdated] = useState(() => localStorage.getItem("swb_lastUpdated") || nowStamp());

        const storageKey = React.useMemo(() => `swb_state_${loginName || "anonymous"}`, [loginName]);
        const [state, setState] = useState(() => {
          const raw = localStorage.getItem(storageKey);
          return raw ? safeParse(raw, null) : null;
        });

        function defaultState() {
          return {
            staffing: {
              cards: seedBadgePool([]), // ensure pool exists
            },
            university: { cards: [] },
          };
        }

        // Seed the protected pool with one badge per role (both depts x BHD options)
        function seedBadgePool(existingCards) {
          const hasPool = existingCards.some(c => c.col === BADGE_POOL_KEY && c.isTemplate);
          if (hasPool) return existingCards;

          const templates = [];
          const depts = ["Demora", "LaborShare"];
          const bhdStates = [true, false];

          for (const dept of depts) {
            for (const role of ROLES) {
              for (const bhd of bhdStates) {
                templates.push({
                  id: "tpl-" + uid(),
                  isTemplate: true,
                  personName: bhd ? "BHD Badge" : "Badge",
                  dept,
                  role,
                  bhd,
                  col: BADGE_POOL_KEY,
                  createdBy: "system",
                  createdAt: new Date().toISOString(),
                });
              }
            }
          }

          return [...templates, ...existingCards];
        }

        useEffect(() => {
          const raw = localStorage.getItem(storageKey);
          if (raw) {
            const parsed = safeParse(raw, defaultState());
            // make sure the pool templates exist even if user had older state
            parsed.staffing.cards = seedBadgePool(parsed.staffing.cards || []);
            setState(parsed);
          } else {
            setState(defaultState());
          }
          // eslint-disable-next-line react-hooks/exhaustive-deps
        }, [storageKey]);

        function touchUpdate(nextState) {
          // Always keep badge pool templates present
          nextState = {
            ...nextState,
            staffing: {
              ...nextState.staffing,
              cards: seedBadgePool(nextState.staffing.cards || []),
            },
          };

          setState(nextState);
          const stamp = nowStamp();
          setLastUpdated(stamp);
          localStorage.setItem("swb_lastUpdated", stamp);
          localStorage.setItem(storageKey, JSON.stringify(nextState));
        }

        useEffect(() => {
          localStorage.setItem("swb_login", loginName);
        }, [loginName]);

        function resetBoard() {
          touchUpdate(defaultState());
        }

        if (!state) return null;

        return (
          <div className="wrap">
            <div className="topbar">
              <div className="title">
                <h1>Staffing Digital Whiteboard</h1>
                <div className="meta">
                  <span><strong>Today:</strong> {todayStr()}</span>
                  <span><strong>Last Updated:</strong> {lastUpdated}</span>
                  <span><strong>Login Name:</strong> {loginName ? loginName : "Not set"}</span>
                </div>
              </div>

              <div className="controls">
                <input
                  value={loginName}
                  onChange={(e) => setLoginName(e.target.value.trimStart())}
                  placeholder="Enter login name (e.g., migueld)"
                  style={{ minWidth: 240 }}
                />
                <button className="danger" onClick={resetBoard} title="Clears both boards for this login (pool remains)">
                  Clear Boards
                </button>
              </div>
            </div>

            <div className="tabs">
              <div className={"tab " + (activeTab === "staffing" ? "active" : "")} onClick={() => setActiveTab("staffing")}>
                Staffing Board
              </div>
              <div className={"tab " + (activeTab === "university" ? "active" : "")} onClick={() => setActiveTab("university")}>
                University Assignments
              </div>
            </div>

            {activeTab === "staffing" ? (
              <StaffingBoard
                data={state.staffing}
                onChange={(nextStaffing) => touchUpdate({ ...state, staffing: nextStaffing })}
                loginName={loginName}
              />
            ) : (
              <UniversityBoard
                data={state.university}
                onChange={(nextUni) => touchUpdate({ ...state, university: nextUni })}
                loginName={loginName}
              />
            )}

            <div className="panel">
              <h3>How the protected Badge Pool works</h3>
              <div className="mutedLine">
                • Anything in <strong>Badge Pool</strong> is a <strong>template</strong> and cannot be deleted.<br/>
                • Drag a template from the pool into any other column to <strong>create a copy</strong> (the pool stays intact).<br/>
                • This lets you keep “badge types” always available while staffing cards on the board can be removed.
              </div>
            </div>
          </div>
        );
      }

      function StaffingBoard({ data, onChange, loginName }) {
        const [newName, setNewName] = useState("");

        const [dragOverCol, setDragOverCol] = useState(null);

        function addPersonCard() {
          const trimmed = newName.trim();
          if (!trimmed) return;

          // Default new card settings (you can edit after)
          const card = {
            id: uid(),
            isTemplate: false,
            personName: trimmed,
            dept: "Demora",
            role: ROLES[0],
            bhd: true,
            col: "planned",
            createdBy: loginName || "anonymous",
            createdAt: new Date().toISOString(),
          };
          onChange({ ...data, cards: [card, ...data.cards] });
          setNewName("");
        }

        function removeCard(id) {
          const target = data.cards.find(c => c.id === id);
          if (target?.isTemplate) return; // protected
          onChange({ ...data, cards: data.cards.filter(c => c.id !== id) });
        }

        function updateCard(id, patch) {
          const target = data.cards.find(c => c.id === id);
          // Templates are editable (dept/role/bhd) if you want, but still not deletable:
          onChange({
            ...data,
            cards: data.cards.map(c => (c.id === id ? { ...c, ...patch } : c)),
          });
        }

        function onDragStart(e, cardId) {
          e.dataTransfer.setData("text/plain", cardId);
          e.dataTransfer.effectAllowed = "move";
        }

        function allowDrop(e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
        }

        function onDrop(e, colKey) {
          e.preventDefault();
          const cardId = e.dataTransfer.getData("text/plain");
          if (!cardId) return;

          const card = data.cards.find(c => c.id === cardId);
          if (!card) return;

          // If dropping a template OUT of the pool: create a copy
          if (card.isTemplate && card.col === BADGE_POOL_KEY && colKey !== BADGE_POOL_KEY) {
            const copy = {
              ...card,
              id: uid(),
              isTemplate: false,
              personName: "(assign name)", // prompt user to edit
              col: colKey,
              createdBy: loginName || "anonymous",
              createdAt: new Date().toISOString(),
            };
            onChange({ ...data, cards: [copy, ...data.cards] });
            setDragOverCol(null);
            return;
          }

          // If trying to drop a non-template into pool, allow it but keep it non-template
          // (If you want to forbid this, I can lock it.)
          updateCard(cardId, { col: colKey });
          setDragOverCol(null);
        }

        const cardsByCol = useMemo(() => {
          const m = {};
          for (const col of STAFFING_COLS) m[col.key] = [];
          for (const c of data.cards) {
            (m[c.col] || (m[c.col] = [])).push(c);
          }

          // Keep templates at the top of the pool
          if (m[BADGE_POOL_KEY]) {
            m[BADGE_POOL_KEY].sort((a,b) => (b.isTemplate === a.isTemplate) ? 0 : (b.isTemplate ? 1 : -1));
          }
          return m;
        }, [data.cards]);

        return (
          <>
            <div className="panel">
              <h3>Add associate (people card)</h3>
              <div className="formRow">
                <input
                  value={newName}
                  onChange={(e) => setNewName(e.target.value)}
                  placeholder="Associate name"
                  style={{ minWidth: 240 }}
                />
                <button className="primary" onClick={addPersonCard}>Add</button>
              </div>

              <div className="mutedLine">
                Tip: If you want “badge-first” staffing, drag a template from <strong>Badge Pool</strong> onto the board, then replace “(assign name)”.
              </div>
            </div>

            <div className="board">
              {STAFFING_COLS.map(col => (
                <div
                  key={col.key}
                  className={"col " + (dragOverCol === col.key ? "dragOver" : "")}
                  onDragOver={(e) => { allowDrop(e); setDragOverCol(col.key); }}
                  onDragLeave={() => setDragOverCol(null)}
                  onDrop={(e) => onDrop(e, col.key)}
                >
                  <div className="colHeader">
                    <div style={{display:"flex", gap:8, alignItems:"center"}}>
                      <h2 style={{margin:0}}>{col.title}</h2>
                      {col.protected ? <span className="protectedTag">Protected</span> : null}
                    </div>
                    <span>{(cardsByCol[col.key] || []).length}</span>
                  </div>

                  <div className="dropZone">
                    {col.key === BADGE_POOL_KEY ? (
                      <div className="hint">
                        Drag a badge template from here onto the board to create a copy. Templates cannot be deleted.
                      </div>
                    ) : (cardsByCol[col.key] || []).length === 0 ? (
                      <div className="hint">Drag cards here.</div>
                    ) : null}

                    {(cardsByCol[col.key] || []).map(card => (
                      <div
                        key={card.id}
                        className="card"
                        draggable
                        onDragStart={(e) => onDragStart(e, card.id)}
                        title={card.isTemplate ? "Template (drag to create a copy)" : "Drag to move"}
                      >
                        <div className="cardTop">
                          <div>
                            <p className="name">
                              {card.personName} {card.isTemplate ? <span className="protectedTag" style={{marginLeft:8}}>Template</span> : null}
                            </p>

                            <div className="row" style={{ marginTop: 8 }}>
                              <span className="pill">{card.dept}</span>
                              <span className={"badge " + (card.bhd ? "bhd" : "notbhd")}>
                                {card.bhd ? "BHD" : "—"} • {card.role}
                              </span>
                            </div>

                            <div className="small" style={{ marginTop: 8 }}>
                              {card.isTemplate ? "System template" : <>Added by <strong>{card.createdBy}</strong></>}
                            </div>
                          </div>

                          <div className="actions">
                            {!card.isTemplate ? (
                              <button className="iconBtn" onClick={() => removeCard(card.id)}>Delete</button>
                            ) : (
                              <button className="iconBtn" disabled title="Templates cannot be deleted">Locked</button>
                            )}
                          </div>
                        </div>

                        {/* Editable fields */}
                        <div className="formRow" style={{ marginTop: 10 }}>
                          {!card.isTemplate ? (
                            <input
                              value={card.personName}
                              onChange={(e) => updateCard(card.id, { personName: e.target.value })}
                              style={{ minWidth: 200 }}
                            />
                          ) : null}

                          <select value={card.dept} onChange={(e) => updateCard(card.id, { dept: e.target.value })}>
                            <option value="Demora">Demora</option>
                            <option value="LaborShare">LaborShare</option>
                          </select>

                          <select value={card.role} onChange={(e) => updateCard(card.id, { role: e.target.value })} style={{ minWidth: 220 }}>
                            {ROLES.map(r => <option key={r} value={r}>{r}</option>)}
                          </select>

                          <select value={card.bhd ? "BHD" : "NotBHD"} onChange={(e) => updateCard(card.id, { bhd: e.target.value === "BHD" })}>
                            <option value="BHD">Back Half Days</option>
                            <option value="NotBHD">Not BHD</option>
                          </select>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </>
        );
      }

      function UniversityBoard({ data, onChange, loginName }) {
        const [course, setCourse] = useState("");
        const [assignment, setAssignment] = useState("");
        const [due, setDue] = useState("");

        const [dragOverCol, setDragOverCol] = useState(null);

        function addAssignment() {
          const c = course.trim();
          const a = assignment.trim();
          if (!c || !a) return;

          const card = {
            id: uid(),
            course: c,
            title: a,
            dueDate: due ? new Date(due).toISOString() : null,
            col: "todo",
            createdBy: loginName || "anonymous",
            createdAt: new Date().toISOString(),
          };
          onChange({ ...data, cards: [card, ...data.cards] });
          setAssignment("");
          setDue("");
        }

        function removeCard(id) {
          onChange({ ...data, cards: data.cards.filter(c => c.id !== id) });
        }

        function updateCard(id, patch) {
          onChange({
            ...data,
            cards: data.cards.map(c => (c.id === id ? { ...c, ...patch } : c)),
          });
        }

        function onDragStart(e, cardId) {
          e.dataTransfer.setData("text/plain", cardId);
          e.dataTransfer.effectAllowed = "move";
        }

        function onDrop(e, colKey) {
          e.preventDefault();
          const cardId = e.dataTransfer.getData("text/plain");
          if (!cardId) return;
          updateCard(cardId, { col: colKey });
          setDragOverCol(null);
        }

        function allowDrop(e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
        }

        const cardsByCol = useMemo(() => {
          const m = {};
          for (const col of UNI_COLS) m[col.key] = [];
          for (const c of data.cards) {
            (m[c.col] || (m[c.col] = [])).push(c);
          }
          return m;
        }, [data.cards]);

        const fmtDue = (iso) => {
          if (!iso) return "No due date";
          const d = new Date(iso);
          return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
        };

        return (
          <>
            <div className="panel">
              <h3>Add assignment</h3>
              <div className="grid2">
                <input value={course} onChange={(e) => setCourse(e.target.value)} placeholder="Class (e.g., BUS 240)"/>
                <input value={assignment} onChange={(e) => setAssignment(e.target.value)} placeholder="Assignment (e.g., Week 3 Discussion)"/>
              </div>
              <div className="formRow">
                <input type="date" value={due} onChange={(e) => setDue(e.target.value)} />
                <button className="primary" onClick={addAssignment}>Add</button>
              </div>
            </div>

            <div className="board" style={{ gridTemplateColumns: "repeat(4, 1fr)" }}>
              {UNI_COLS.map(col => (
                <div
                  key={col.key}
                  className={"col " + (dragOverCol === col.key ? "dragOver" : "")}
                  onDragOver={(e) => { allowDrop(e); setDragOverCol(col.key); }}
                  onDragLeave={() => setDragOverCol(null)}
                  onDrop={(e) => onDrop(e, col.key)}
                >
                  <div className="colHeader">
                    <h2>{col.title}</h2>
                    <span>{(cardsByCol[col.key] || []).length}</span>
                  </div>

                  <div className="dropZone">
                    {(cardsByCol[col.key] || []).length === 0 ? (
                      <div className="hint">Drag cards here.</div>
                    ) : null}

                    {(cardsByCol[col.key] || []).map(card => (
                      <div
                        key={card.id}
                        className="card"
                        draggable
                        onDragStart={(e) => onDragStart(e, card.id)}
                        title="Drag to move"
                      >
                        <div className="cardTop">
                          <div>
                            <p className="name">{card.title}</p>
                            <div className="row" style={{ marginTop: 8 }}>
                              <span className="pill">{card.course}</span>
                              <span className="pill">Due: {fmtDue(card.dueDate)}</span>
                            </div>
                            <div className="small" style={{ marginTop: 8 }}>
                              Added by <strong>{card.createdBy}</strong>
                            </div>
                          </div>
                          <div className="actions">
                            <button className="iconBtn" onClick={() => removeCard(card.id)}>Delete</button>
                          </div>
                        </div>

                        <div className="formRow" style={{ marginTop: 10 }}>
                          <input
                            value={card.course}
                            onChange={(e) => updateCard(card.id, { course: e.target.value })}
                            style={{ minWidth: 180 }}
                          />
                          <input
                            value={card.title}
                            onChange={(e) => updateCard(card.id, { title: e.target.value })}
                            style={{ minWidth: 220 }}
                          />
                          <input
                            type="date"
                            value={card.dueDate ? new Date(card.dueDate).toISOString().slice(0,10) : ""}
                            onChange={(e) => updateCard(card.id, { dueDate: e.target.value ? new Date(e.target.value).toISOString() : null })}
                          />
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
