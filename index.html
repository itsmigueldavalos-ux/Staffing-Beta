<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Staffing Digital Whiteboard</title>
  <style>
    :root{
      --bg:#0b1220;
      --text:#e8eefc;
      --muted:#a8b3cf;
      --border:rgba(255,255,255,.10);
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --danger:#ff5c5c;
      --ok:#2ecc71;
      --chip:#1a2440;

      /* badge colors */
      --badgeBlue:#1f6feb;   /* Back Half Days */
      --badgeTeal:#0ea5a5;   /* Shift Pattern Co-Host */
      --rolePurple:#7c3aed;  /* Role badge */
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% 10%, #16264b 0%, var(--bg) 55%);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background: linear-gradient(180deg, rgba(11,18,32,.98), rgba(11,18,32,.85));
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:14px 16px;}
    .topbar{display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;}
    .brand{display:flex; align-items:baseline; gap:10px; flex-wrap:wrap;}
    .brand h1{font-size:18px; margin:0; letter-spacing:.2px;}
    .meta{display:flex; gap:12px; align-items:center; color:var(--muted); font-size:13px; flex-wrap:wrap;}
    .pill{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      padding:6px 10px;
      border-radius:999px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      box-shadow: 0 1px 0 rgba(255,255,255,.05) inset;
      flex-wrap:wrap;
    }
    .controls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      width:100%;
      margin-top:10px;
    }
    input, select, button{
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      outline:none;
    }
    input::placeholder{color:rgba(232,238,252,.55)}
    input:focus, select:focus{
      border-color: rgba(110,168,254,.6);
      box-shadow: 0 0 0 3px rgba(110,168,254,.18);
    }
    button{
      cursor:pointer;
      background: rgba(110,168,254,.14);
      border-color: rgba(110,168,254,.35);
      font-weight:600;
    }
    button:hover{background: rgba(110,168,254,.22)}
    .dangerBtn{
      background: rgba(255,92,92,.14);
      border-color: rgba(255,92,92,.35);
    }
    .dangerBtn:hover{background: rgba(255,92,92,.22)}
    .grow{flex:1; min-width:220px;}

    main{max-width:1200px; margin:0 auto; padding:16px;}
    .board{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:14px;
    }
    @media (max-width: 980px){
      .board{grid-template-columns:1fr}
    }
    .col{
      background: linear-gradient(180deg, rgba(16,26,46,.78), rgba(14,23,42,.78));
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height:360px;
      display:flex;
      flex-direction:column;
    }
    .colhead{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .coltitle{display:flex; flex-direction:column; gap:6px;}
    .coltitle strong{font-size:14px; letter-spacing:.2px;}
    .colsub{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
      font-size:12px; color:var(--muted);
    }

    .indicator{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: var(--danger);
      box-shadow: 0 0 0 3px rgba(255,92,92,.14);
    }
    .dot.ok{
      background: var(--ok);
      box-shadow: 0 0 0 3px rgba(46,204,113,.14);
    }
    .targetInput{
      width:86px;
      padding:6px 8px;
      border-radius:10px;
      font-size:12px;
    }

    .dropzone{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:1;
    }
    .dropzone.dragover{
      outline:2px dashed rgba(110,168,254,.6);
      outline-offset:-6px;
      background: rgba(110,168,254,.07);
    }

    .card{
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px 10px 8px;
      box-shadow: 0 2px 0 rgba(255,255,255,.04) inset;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .card[draggable="true"]{cursor:grab}
    .card:active{cursor:grabbing}

    .cardTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .leftRow{
      display:flex; gap:10px; align-items:flex-start; min-width:0;
      flex:1;
    }
    .avatar{
      width:36px; height:36px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      flex:0 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      color: rgba(232,238,252,.75);
    }
    .avatar img{width:100%; height:100%; object-fit:cover; display:block;}
    .who{display:flex; flex-direction:column; gap:2px; min-width:0; flex:1;}
    .name{
      font-weight:700;
      font-size:14px;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .login{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .chips{display:flex; gap:6px; flex-wrap:wrap; align-items:center;}
    .chip{
      font-size:11px;
      padding:5px 8px;
      border-radius:999px;
      background: var(--chip);
      border:1px solid var(--border);
      color: var(--text);
      display:inline-flex; align-items:center; gap:6px;
      max-width: 100%;
    }
    .chip.blue{
      background: rgba(31,111,235,.18);
      border-color: rgba(31,111,235,.45);
      color: #dbeafe;
    }
    .chip.teal{
      background: rgba(14,165,165,.16);
      border-color: rgba(14,165,165,.45);
      color: #d8ffff;
    }
    .chip.role{
      background: rgba(124,58,237,.16);
      border-color: rgba(124,58,237,.45);
      color: #efe6ff;
    }
    .chip .clip{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 240px;
      display:inline-block;
      vertical-align:bottom;
    }

    .badgeAvatar{
      width:16px; height:16px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
      overflow:hidden;
      background: rgba(255,255,255,.08);
      display:inline-flex; align-items:center; justify-content:center;
      flex:0 0 auto;
    }
    .badgeAvatar img{width:100%; height:100%; object-fit:cover; display:block;}

    .miniBtn{
      font-size:12px;
      padding:6px 8px;
      border-radius:10px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--border);
      color: var(--text);
      cursor:pointer;
    }
    .miniBtn:hover{background: rgba(255,255,255,.07)}

    /* Modal */
    .modalBack{
      position:fixed; inset:0; background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(720px, 100%);
      background: linear-gradient(180deg, rgba(16,26,46,.98), rgba(14,23,42,.98));
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .modalBody{padding:14px; display:grid; gap:12px;}
    .modalFoot{
      padding:12px 14px;
      border-top:1px solid var(--border);
      display:flex; justify-content:flex-end; gap:10px;
      flex-wrap:wrap;
    }
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px;}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width:560px){ .grid2{grid-template-columns:1fr} }

    .photoRow{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      padding:10px;
      border-radius:14px;
    }
    .photoPreview{
      width:56px; height:56px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      font-weight:800;
      color: rgba(232,238,252,.75);
      flex:0 0 auto;
    }
    .photoPreview img{width:100%; height:100%; object-fit:cover; display:block;}
    .photoActions{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .fileInput{
      font-size:12px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      max-width: 360px;
    }

    .checks{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      padding:10px;
      border-radius:14px;
    }
    .check{
      display:flex;
      gap:8px;
      align-items:center;
      padding:6px 8px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius:12px;
    }
    .check input{width:16px; height:16px; padding:0}
    .check span{font-size:12px; color: var(--text)}
  </style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>Staffing Digital Whiteboard</h1>
        <div class="pill" title="Auto-updating date">
          <span id="todayTxt"></span>
        </div>
      </div>

      <div class="meta">
        <div class="pill" title="Your local login name (stored on this device)">
          <span>Logged in as:</span>
          <strong id="loggedInAs">Not set</strong>
          <button class="miniBtn" id="btnLogin">Set</button>
        </div>

        <div class="pill" title="Headcount targets (saved on this device)">
          <span style="color:var(--muted)">Targets:</span>
          <span style="display:inline-flex;gap:8px;flex-wrap:wrap;align-items:center">
            <span>Inbound</span><input id="tInbound" class="targetInput" type="number" min="0" step="1" />
            <span>Outbound</span><input id="tOutbound" class="targetInput" type="number" min="0" step="1" />
            <span>Demora</span><input id="tDemora" class="targetInput" type="number" min="0" step="1" />
          </span>
        </div>
      </div>
    </div>

    <div class="controls">
      <input id="search" class="grow" placeholder="Search associate name, login, or role…" />
      <button id="btnAdd">+ Add Associate</button>
      <button id="btnClear" class="dangerBtn" title="Clears board data on this device">Clear Board</button>
    </div>
  </div>
</header>

<main>
  <div class="board" id="board"></div>
</main>

<!-- Add/Edit Modal -->
<div class="modalBack" id="modalBack" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modalHead">
      <strong id="modalTitle">Add Associate</strong>
      <button class="miniBtn" id="btnCloseModal">Close</button>
    </div>

    <div class="modalBody">
      <div class="grid2">
        <div>
          <label for="inpName">Associate name</label>
          <input id="inpName" placeholder="e.g., Jordan Smith" />
        </div>
        <div>
          <label for="inpLogin">Login</label>
          <input id="inpLogin" placeholder="e.g., jsmith" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label for="selDept">Department</label>
          <select id="selDept">
            <option value="Inbound">Inbound</option>
            <option value="Outbound">Outbound</option>
            <option value="Demora">Demora</option>
          </select>
        </div>
        <div>
          <label for="selRole">Role / Path (badge)</label>
          <select id="selRole">
            <option value="">None</option>
            <option value="Problem Solver">Problem Solver</option>
            <option value="Picker">Picker</option>
            <option value="Stower">Stower</option>
            <option value="Process Guide - Pick">Process Guide - Pick</option>
            <option value="Process Guide - Stow">Process Guide - Stow</option>
            <option value="Decanter">Decanter</option>
            <option value="Pick Transporter">Pick Transporter</option>
            <option value="Stow Transporter">Stow Transporter</option>
            <option value="WaterSpider">WaterSpider</option>
            <option value="ICQA">ICQA</option>
          </select>
        </div>
      </div>

      <!-- NEW: Multi-select badges -->
      <div>
        <label>Badges</label>
        <div class="checks">
          <label class="check" title="Back Half Days (Blue badge)">
            <input id="chkBHD" type="checkbox" />
            <span>Back Half Days (Blue)</span>
          </label>

          <label class="check" title="Shift Pattern Co-Host badge">
            <input id="chkCOHOST" type="checkbox" />
            <span>Shift Pattern Co-Host</span>
          </label>
        </div>
      </div>

      <div>
        <label>Photo on badge (Upload Image)</label>
        <div class="photoRow">
          <div class="photoPreview" id="photoPreview">
            <span id="photoInitial">?</span>
            <img id="photoImg" alt="" style="display:none;" />
          </div>
          <div class="photoActions">
            <input class="fileInput" id="inpPhoto" type="file" accept="image/*" />
            <button class="miniBtn" id="btnRemovePhoto" type="button">Remove Photo</button>
          </div>
          <div style="color:var(--muted);font-size:12px;">
            Stored locally on this device (no URLs).
          </div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:12px;">
        <span>Tip: drag-and-drop cards between departments.</span>
        <span id="editId" style="display:none;"></span>
      </div>
    </div>

    <div class="modalFoot">
      <button id="btnDelete" class="dangerBtn" style="display:none;">Delete</button>
      <button id="btnSave">Save</button>
    </div>
  </div>
</div>

<!-- Login Modal -->
<div class="modalBack" id="loginBack" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="modalHead">
      <strong id="loginTitle">Set Login Name</strong>
      <button class="miniBtn" id="btnCloseLogin">Close</button>
    </div>
    <div class="modalBody">
      <div>
        <label for="inpManager">Your name (shown as “Logged in as”)</label>
        <input id="inpManager" placeholder="e.g., Miguel Davalos" />
      </div>
      <div style="display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:12px;">
        <span>This is a simple local login (no passwords).</span>
        <span></span>
      </div>
    </div>
    <div class="modalFoot">
      <button id="btnSaveLogin">Save</button>
    </div>
  </div>
</div>

<script>
(() => {
  const STORAGE_KEY = "staffing_whiteboard_v4";
  const LOGIN_KEY = "staffing_whiteboard_login_v1";
  const TARGETS_KEY = "staffing_whiteboard_targets_v1";

  const departments = ["Inbound", "Outbound", "Demora"];

  /** State shape:
   * { cards: [{id, name, login, dept, badges:[], role, photoDataUrl}], updatedAt }
   */
  const state = loadState();

  // Elements
  const boardEl = document.getElementById("board");
  const searchEl = document.getElementById("search");
  const btnAdd = document.getElementById("btnAdd");
  const btnClear = document.getElementById("btnClear");

  const todayTxt = document.getElementById("todayTxt");
  const loggedInAs = document.getElementById("loggedInAs");
  const btnLogin = document.getElementById("btnLogin");

  // Targets
  const tInbound = document.getElementById("tInbound");
  const tOutbound = document.getElementById("tOutbound");
  const tDemora = document.getElementById("tDemora");
  const targets = loadTargets();

  // Add/Edit modal
  const modalBack = document.getElementById("modalBack");
  const btnCloseModal = document.getElementById("btnCloseModal");
  const btnSave = document.getElementById("btnSave");
  const btnDelete = document.getElementById("btnDelete");

  const inpName = document.getElementById("inpName");
  const inpLogin = document.getElementById("inpLogin");
  const selDept = document.getElementById("selDept");
  const selRole = document.getElementById("selRole");
  const chkBHD = document.getElementById("chkBHD");
  const chkCOHOST = document.getElementById("chkCOHOST");
  const editId = document.getElementById("editId");
  const modalTitle = document.getElementById("modalTitle");

  // Photo upload
  const inpPhoto = document.getElementById("inpPhoto");
  const btnRemovePhoto = document.getElementById("btnRemovePhoto");
  const photoImg = document.getElementById("photoImg");
  const photoInitial = document.getElementById("photoInitial");

  let modalPhotoDataUrl = "";

  // Login modal
  const loginBack = document.getElementById("loginBack");
  const btnCloseLogin = document.getElementById("btnCloseLogin");
  const btnSaveLogin = document.getElementById("btnSaveLogin");
  const inpManager = document.getElementById("inpManager");

  // Date
  function setDate() {
    const d = new Date();
    const fmt = d.toLocaleDateString(undefined, { weekday:"short", year:"numeric", month:"short", day:"numeric" });
    todayTxt.textContent = fmt;
  }
  setDate();
  setInterval(setDate, 60_000);

  // Login
  function loadLogin() {
    const v = localStorage.getItem(LOGIN_KEY) || "";
    loggedInAs.textContent = v.trim() ? v : "Not set";
    inpManager.value = v;
  }
  function saveLogin() {
    localStorage.setItem(LOGIN_KEY, (inpManager.value || "").trim());
    loadLogin();
    closeLogin();
  }
  loadLogin();

  // Targets UI
  tInbound.value = targets.Inbound;
  tOutbound.value = targets.Outbound;
  tDemora.value = targets.Demora;

  function clampNonNegInt(v){
    const n = Math.max(0, Math.floor(Number(v || 0)));
    return Number.isFinite(n) ? n : 0;
  }
  function onTargetsChange(){
    targets.Inbound = clampNonNegInt(tInbound.value);
    targets.Outbound = clampNonNegInt(tOutbound.value);
    targets.Demora = clampNonNegInt(tDemora.value);
    tInbound.value = targets.Inbound;
    tOutbound.value = targets.Outbound;
    tDemora.value = targets.Demora;
    saveTargets(targets);
    render();
  }
  tInbound.addEventListener("change", onTargetsChange);
  tOutbound.addEventListener("change", onTargetsChange);
  tDemora.addEventListener("change", onTargetsChange);

  // Render
  function render() {
    const q = (searchEl.value || "").trim().toLowerCase();

    boardEl.innerHTML = "";
    for (const dept of departments) {
      const col = document.createElement("section");
      col.className = "col";

      const head = document.createElement("div");
      head.className = "colhead";

      const title = document.createElement("div");
      title.className = "coltitle";

      const strong = document.createElement("strong");
      strong.textContent = dept;

      const sub = document.createElement("div");
      sub.className = "colsub";

      const count = state.cards.filter(c => c.dept === dept).length;
      const target = targets[dept] ?? 0;

      const indicator = document.createElement("span");
      indicator.className = "indicator";

      const dot = document.createElement("span");
      dot.className = "dot";

      const ok = (target === 0) ? true : (count >= target);
      if (ok) dot.classList.add("ok");

      const text = document.createElement("span");
      text.textContent = `HC ${count} / Target ${target}`;

      indicator.append(dot, text);

      const addBtn = document.createElement("button");
      addBtn.className = "miniBtn";
      addBtn.textContent = "Add";
      addBtn.addEventListener("click", () => openModal({ dept }));

      sub.appendChild(indicator);
      title.append(strong, sub);
      head.append(title, addBtn);

      const zone = document.createElement("div");
      zone.className = "dropzone";
      zone.dataset.dept = dept;

      zone.addEventListener("dragover", (e) => {
        e.preventDefault();
        zone.classList.add("dragover");
      });
      zone.addEventListener("dragleave", () => zone.classList.remove("dragover"));
      zone.addEventListener("drop", (e) => {
        e.preventDefault();
        zone.classList.remove("dragover");
        const id = e.dataTransfer.getData("text/plain");
        if (!id) return;
        moveCard(id, dept);
      });

      const cards = state.cards
        .filter(c => c.dept === dept)
        .filter(c => {
          if (!q) return true;
          const badgesText = (c.badges || []).join(" ").toLowerCase();
          return (c.name || "").toLowerCase().includes(q)
              || (c.login || "").toLowerCase().includes(q)
              || (c.role || "").toLowerCase().includes(q)
              || badgesText.includes(q);
        });

      for (const c of cards) zone.appendChild(renderCard(c, q));

      col.append(head, zone);
      boardEl.appendChild(col);
    }
  }

  function renderBadgeChip(code, c){
    // Optional photo on chip
    const withAvatar = !!c.photoDataUrl;

    if (code === "BHD") {
      const chip = document.createElement("span");
      chip.className = "chip blue";

      if (withAvatar) {
        const bav = document.createElement("span");
        bav.className = "badgeAvatar";
        const bi = document.createElement("img");
        bi.src = c.photoDataUrl;
        bi.alt = "";
        bav.appendChild(bi);
        chip.appendChild(bav);
      }

      const txt = document.createElement("span");
      txt.className = "clip";
      txt.textContent = "Back Half Days";
      chip.appendChild(txt);
      return chip;
    }

    if (code === "COHOST") {
      const chip = document.createElement("span");
      chip.className = "chip teal";

      if (withAvatar) {
        const bav = document.createElement("span");
        bav.className = "badgeAvatar";
        const bi = document.createElement("img");
        bi.src = c.photoDataUrl;
        bi.alt = "";
        bav.appendChild(bi);
        chip.appendChild(bav);
      }

      const txt = document.createElement("span");
      txt.className = "clip";
      txt.textContent = "Shift Pattern Co-Host";
      chip.appendChild(txt);
      return chip;
    }

    return null;
  }

  function renderCard(c, searching) {
    const card = document.createElement("div");
    card.className = "card";
    card.draggable = true;
    card.dataset.id = c.id;

    card.addEventListener("dragstart", (e) => {
      e.dataTransfer.setData("text/plain", c.id);
      e.dataTransfer.effectAllowed = "move";
    });

    const top = document.createElement("div");
    top.className = "cardTop";

    const left = document.createElement("div");
    left.className = "leftRow";

    const av = document.createElement("div");
    av.className = "avatar";
    const initial = (c.name || c.login || "?").trim().charAt(0).toUpperCase() || "?";

    if (c.photoDataUrl) {
      const img = document.createElement("img");
      img.src = c.photoDataUrl;
      img.alt = "";
      av.innerHTML = "";
      av.appendChild(img);
    } else {
      av.textContent = initial;
    }

    const who = document.createElement("div");
    who.className = "who";

    const name = document.createElement("div");
    name.className = "name";
    name.textContent = c.name || "(No name)";

    const login = document.createElement("div");
    login.className = "login";
    login.textContent = c.login ? `@${c.login}` : "(No login)";

    who.append(name, login);
    left.append(av, who);

    const actions = document.createElement("div");
    const editBtn = document.createElement("button");
    editBtn.className = "miniBtn";
    editBtn.textContent = "Edit";
    editBtn.addEventListener("click", () => openModal(c));
    actions.appendChild(editBtn);

    top.append(left, actions);

    const chips = document.createElement("div");
    chips.className = "chips";

    // Badges (multi)
    const badges = Array.isArray(c.badges) ? c.badges : [];
    for (const b of badges) {
      const chip = renderBadgeChip(b, c);
      if (chip) chips.appendChild(chip);
    }

    // Role/Path badge
    if (c.role) {
      const chip = document.createElement("span");
      chip.className = "chip role";

      if (c.photoDataUrl) {
        const bav = document.createElement("span");
        bav.className = "badgeAvatar";
        const bi = document.createElement("img");
        bi.src = c.photoDataUrl;
        bi.alt = "";
        bav.appendChild(bi);
        chip.appendChild(bav);
      }

      const txt = document.createElement("span");
      txt.className = "clip";
      txt.textContent = c.role;
      chip.appendChild(txt);

      chips.appendChild(chip);
    }

    if (searching) {
      const deptChip = document.createElement("span");
      deptChip.className = "chip";
      deptChip.textContent = c.dept;
      chips.appendChild(deptChip);
    }

    card.append(top);
    if (chips.childElementCount) card.append(chips);

    return card;
  }

  // State ops
  function addCard(data) {
    state.cards.unshift({
      id: crypto.randomUUID(),
      name: (data.name || "").trim(),
      login: (data.login || "").trim(),
      dept: data.dept || "Inbound",
      badges: data.badges || [],
      role: data.role || "",
      photoDataUrl: data.photoDataUrl || ""
    });
    touch();
  }

  function updateCard(id, data) {
    const i = state.cards.findIndex(c => c.id === id);
    if (i === -1) return;
    state.cards[i] = {
      ...state.cards
